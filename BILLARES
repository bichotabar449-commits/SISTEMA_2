<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n para Billar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .connection-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
            font-weight: 600;
        }

        .connection-status.connected {
            background: #43e97b;
            color: white;
        }

        .connection-status.disconnected {
            background: #f5576c;
            color: white;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
        }

        .card-title {
            font-size: 1.5em;
            color: #333;
            font-weight: 600;
        }

        .table-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .table-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .table-item:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .table-item.occupied {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .table-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .table-status {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .table-time {
            font-size: 1.2em;
            margin-top: 10px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 233, 123, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: white;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .history-amount {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
        }

        .product-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .code-box {
            background: #2d2d2d;
            color: #f8f8f2;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .table-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé± Sistema de Gesti√≥n para Billar</h1>
            <p>Gesti√≥n profesional con INNOVASOFT</p>
            <div id="connectionStatus" class="connection-status disconnected">
                ‚ö†Ô∏è No Configurado
            </div>
        </div>

        <div class="main-grid">
            <!-- Mesas de Billar -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üé±</div>
                    <div class="card-title">Mesas de Billar</div>
                </div>
                <div class="table-grid" id="tablesGrid"></div>
            </div>

            <!-- Estad√≠sticas -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üìä</div>
                    <div class="card-title">Estad√≠sticas del D√≠a</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="activeTables">0</div>
                        <div class="stat-label">Activas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalRevenue">$0</div>
                        <div class="stat-label">Ingresos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalSessions">0</div>
                        <div class="stat-label">Sesiones</div>
                    </div>
                </div>
            </div>

            <!-- Ventas R√°pidas -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üõí</div>
                    <div class="card-title">Venta R√°pida</div>
                </div>
                <div class="form-group">
                    <label>Producto</label>
                    <select id="productSelect">
                        <option value="">Seleccionar producto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cantidad</label>
                    <input type="number" id="productQuantity" value="1" min="1">
                </div>
                <button class="btn btn-success" id="btnQuickSale">Agregar Venta</button>
            </div>

            <!-- Configuraci√≥n -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">‚öôÔ∏è</div>
                    <div class="card-title">Configuraci√≥n</div>
                </div>
                <button class="btn btn-primary" id="btnConfigSheets" style="width: 100%; margin-bottom: 10px;">
                    üîó Configurar Google Sheets
                </button>
                <button class="btn btn-primary" id="btnManageProducts" style="width: 100%; margin-bottom: 10px;">
                    Gestionar Productos
                </button>
                <button class="btn btn-primary" id="btnConfigTables" style="width: 100%; margin-bottom: 10px;">
                    Configurar Mesas
                </button>
                <button class="btn btn-primary" id="btnConfigPrices" style="width: 100%;">
                    Configurar Precios
                </button>
            </div>
        </div>

        <!-- Historial de Ventas -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üìù</div>
                <div class="card-title">Historial de Hoy</div>
            </div>
            <button class="btn btn-success" id="btnSyncSheets" style="margin-bottom: 15px;">
                ‚òÅÔ∏è Guardar en Google Sheets
            </button>
            <button class="btn btn-danger" id="btnClearHistory" style="margin-bottom: 15px;">
                Limpiar Historial
            </button>
            <button class="btn btn-primary" id="btnExportReport" style="margin-bottom: 15px;">
                üìÑ Exportar Reporte
            </button>
            <div id="salesHistory"></div>
        </div>
    </div>

    <!-- Modal -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Mesa #1</div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let tables = [];
        let sales = [];
        let activeIntervals = {};
        let HOURLY_RATE = 15000;
        let NUM_TABLES = 8;
        let SHEETS_URL = '';
        let currentUser = null; // Usuario actual logueado
        
        let products = [
            { name: 'Cerveza', price: 5000 },
            { name: 'Gaseosa', price: 3000 },
            { name: 'Agua', price: 2000 },
            { name: 'Snack', price: 4000 },
            { name: 'Michelada', price: 7000 },
            { name: 'Caf√©', price: 2500 },
            { name: 'Sandwich', price: 8000 }
        ];

        // ========================================
        // SISTEMA DE LOGIN
        // ========================================
        
        function checkLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainSystem();
            } else {
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            document.body.innerHTML = `
                <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
                        <h1 style="text-align: center; color: #667eea; margin-bottom: 30px;">üé± Sistema de Billar</h1>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">Usuario</label>
                            <input type="text" id="loginUsername" placeholder="Ingresa tu usuario" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">Contrase√±a</label>
                            <input type="password" id="loginPassword" placeholder="Ingresa tu contrase√±a" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                        </div>
                        <button onclick="handleLogin()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer;">
                            Ingresar
                        </button>
                        <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;">
                            üë§ Usuario: <strong>admin</strong> | Contrase√±a: <strong>admin123</strong><br>
                            üë§ Usuario: <strong>usuario</strong> | Contrase√±a: <strong>user123</strong>
                        </p>
                    </div>
                </div>
            `;

            setTimeout(() => {
                document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') handleLogin();
                });
            }, 100);
        }

        function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            // Credenciales hardcodeadas
            const users = {
                'admin': { password: 'admin123', role: 'admin' },
                'usuario': { password: 'user123', role: 'user' }
            };

            if (users[username] && users[username].password === password) {
                currentUser = { username, role: users[username].role };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                location.reload(); // Recargar para mostrar el sistema
            } else {
                alert('‚ùå Usuario o contrase√±a incorrectos');
            }
        }

        function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                location.reload();
            }
        }

        function showMainSystem() {
            // El sistema ya est√° cargado, solo ocultamos el bot√≥n de config si no es admin
            if (currentUser.role !== 'admin') {
                const btnConfig = document.getElementById('btnConfigSheets');
                if (btnConfig) btnConfig.style.display = 'none';
            }

            // Agregar bot√≥n de logout en el header
            const header = document.querySelector('.header');
            const userInfo = document.createElement('div');
            userInfo.style.cssText = 'margin-top: 10px; color: #667eea; font-weight: 600;';
            userInfo.innerHTML = `
                üë§ ${currentUser.username} ${currentUser.role === 'admin' ? '(Administrador)' : ''}
                <button onclick="logout()" style="margin-left: 15px; padding: 5px 15px; background: #f5576c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                    Cerrar Sesi√≥n
                </button>
            `;
            header.appendChild(userInfo);
        }

        // ========================================
        // CONFIGURACI√ìN Y PERSISTENCIA
        // ========================================
        
        function loadConfig() {
            const savedRate = localStorage.getItem('hourlyRate');
            const savedTables = localStorage.getItem('numTables');
            const savedProducts = localStorage.getItem('products');
            const savedUrl = localStorage.getItem('sheetsUrl');
            
            if (savedRate) HOURLY_RATE = parseInt(savedRate);
            if (savedTables) NUM_TABLES = parseInt(savedTables);
            if (savedProducts) products = JSON.parse(savedProducts);
            if (savedUrl) {
                SHEETS_URL = savedUrl;
                updateConnectionStatus();
            }

            // CARGAR DATOS PERSISTENTES
            loadPersistentData();
        }

        function loadPersistentData() {
            // Cargar mesas guardadas
            const savedTables = localStorage.getItem('activeTables');
            if (savedTables) {
                const parsedTables = JSON.parse(savedTables);
                // Restaurar mesas con su estado
                parsedTables.forEach(savedTable => {
                    const table = tables.find(t => t.id === savedTable.id);
                    if (table && savedTable.occupied) {
                        table.occupied = savedTable.occupied;
                        table.startTime = savedTable.startTime;
                        table.customers = savedTable.customers;
                        table.elapsedTime = savedTable.elapsedTime;
                        
                        // Reiniciar el intervalo de tiempo
                        activeIntervals[table.id] = setInterval(() => {
                            updateTableTime(table.id);
                        }, 1000);
                    }
                });
            }

            // Cargar ventas guardadas
            const savedSales = localStorage.getItem('todaySales');
            if (savedSales) {
                sales = JSON.parse(savedSales).map(s => ({
                    ...s,
                    timestamp: new Date(s.timestamp)
                }));
            }
        }

        function savePersistentData() {
            // Guardar estado de las mesas
            localStorage.setItem('activeTables', JSON.stringify(tables));
            
            // Guardar ventas
            localStorage.setItem('todaySales', JSON.stringify(sales));
        }

        function saveConfig() {
            localStorage.setItem('hourlyRate', HOURLY_RATE);
            localStorage.setItem('numTables', NUM_TABLES);
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('sheetsUrl', SHEETS_URL);
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            if (SHEETS_URL) {
                statusEl.className = 'connection-status connected';
                statusEl.textContent = '‚úì Conectado a Google Sheets';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.textContent = '‚ö†Ô∏è No Configurado';
            }
        }

        // ========================================
        // GOOGLE SHEETS
        // ========================================

        function openSheetsConfig() {
            const modal = document.getElementById('tableModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = 'üîó Configurar Google Sheets';
            body.innerHTML = `
                <div class="alert alert-success">
                    <strong>‚úì 100% GRATIS</strong> - Sin costos, sin l√≠mites
                </div>

                <div class="alert alert-info" style="text-align: left;">
                    <strong>üìã PASOS R√ÅPIDOS:</strong><br><br>
                    1. Crea una Google Sheet<br>
                    2. Ve a <strong>Extensiones ‚Üí Apps Script</strong><br>
                    3. Borra todo y pega el c√≥digo Code.gs<br>
                    4. Guarda (Ctrl + S)<br>
                    5. <strong>Implementar ‚Üí Nueva implementaci√≥n</strong><br>
                    6. Tipo: <strong>Aplicaci√≥n web</strong><br>
                    7. Ejecutar como: <strong>Yo</strong><br>
                    8. Acceso: <strong>Cualquier persona</strong><br>
                    9. <strong>Copia la URL (termina en /exec)</strong><br>
                    10. P√©gala abajo üëá
                </div>

                <div class="alert alert-warning" style="text-align: left;">
                    <strong>‚ö†Ô∏è MUY IMPORTANTE:</strong><br>
                    ‚Ä¢ La URL DEBE terminar en <strong>/exec</strong> (NO /dev)<br>
                    ‚Ä¢ Si cambias el c√≥digo, crea una <strong>NUEVA implementaci√≥n</strong>
                </div>

                <div class="form-group">
                    <label>URL del Apps Script (termina en /exec)</label>
                    <input type="text" id="sheetsUrlInput" value="${SHEETS_URL}" 
                           placeholder="https://script.google.com/macros/s/...../exec">
                </div>

                <button class="btn btn-success" id="btnSaveSheetsUrl">üíæ Guardar y Probar Conexi√≥n</button>
                <button class="btn btn-danger" id="btnCloseModal">Cancelar</button>
            `;
            modal.classList.add('active');

            // Event listeners del modal
            document.getElementById('btnSaveSheetsUrl').addEventListener('click', saveSheetsUrl);
            document.getElementById('btnCloseModal').addEventListener('click', closeModal);
        }

        async function saveSheetsUrl() {
            const url = document.getElementById('sheetsUrlInput').value.trim();
            
            if (!url) {
                alert('‚ö†Ô∏è Por favor ingresa la URL del Apps Script');
                return;
            }

            if (!url.includes('script.google.com')) {
                alert('‚ö†Ô∏è La URL debe ser de Google Apps Script\n(debe contener script.google.com)');
                return;
            }

            if (!url.endsWith('/exec')) {
                alert('‚ö†Ô∏è La URL debe terminar en /exec\n\nTu URL termina en: ' + url.split('/').pop() + '\n\nAseg√∫rate de copiar la URL de la implementaci√≥n, no del editor.');
                return;
            }

            SHEETS_URL = url;
            saveConfig();
            updateConnectionStatus();

            // Probar conexi√≥n e inicializar
            const testBtn = document.getElementById('btnSaveSheetsUrl');
            testBtn.disabled = true;
            testBtn.textContent = '‚è≥ Probando conexi√≥n...';

            try {
                const initResult = await initializeRemoteDatabase();
                
                if (initResult) {
                    alert('‚úÖ ¬°CONEXI√ìN EXITOSA!\n\n' +
                          'üìä Base de datos inicializada:\n' +
                          '  ‚Ä¢ Hoja de Ventas\n' +
                          '  ‚Ä¢ Historial de Mesas\n' +
                          '  ‚Ä¢ Productos Vendidos\n' +
                          '  ‚Ä¢ Resumen Diario\n' +
                          '  ‚Ä¢ Configuraci√≥n\n\n' +
                          'üéâ ¬°Ya puedes empezar a usar el sistema!');
                    closeModal();
                } else {
                    throw new Error('No se pudo inicializar');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå ERROR DE CONEXI√ìN\n\n' +
                      'Verifica que:\n' +
                      '1. Hayas IMPLEMENTADO el script (no solo guardado)\n' +
                      '2. La implementaci√≥n sea tipo "Aplicaci√≥n web"\n' +
                      '3. "Ejecutar como" sea "Yo"\n' +
                      '4. "Acceso" sea "Cualquier persona"\n' +
                      '5. La URL termine en /exec\n\n' +
                      'Si ya lo hiciste todo, intenta crear una NUEVA implementaci√≥n.');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'üíæ Guardar y Probar Conexi√≥n';
            }
        }

        async function initializeRemoteDatabase() {
            try {
                console.log('üì° Inicializando base de datos...');
                
                const response = await fetch(SHEETS_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({ action: 'initialize' })
                });

                console.log('üì• Respuesta recibida:', response.status);

                if (!response.ok) {
                    console.error('‚ùå Respuesta no OK:', response.status);
                    return false;
                }

                const text = await response.text();
                console.log('üìÑ Texto de respuesta:', text);
                
                const result = JSON.parse(text);
                console.log('‚úÖ Resultado:', result);
                
                return result.status === 'success';
            } catch (error) {
                console.error('‚ùå Error:', error);
                return false;
            }
        }

        async function saveToSheetsAuto(salesToSave) {
            if (!SHEETS_URL) {
                console.warn('‚ö†Ô∏è Google Sheets no configurado');
                return;
            }

            try {
                console.log('üì§ Guardando autom√°ticamente...');
                
                const response = await fetch(SHEETS_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({
                        action: 'save_sales',
                        sales: salesToSave
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const text = await response.text();
                const result = JSON.parse(text);
                
                if (result.status === 'success') {
                    console.log('‚úÖ Guardado autom√°tico exitoso');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('‚ùå Error en guardado autom√°tico:', error);
                // No mostrar alert para no interrumpir el flujo
            }
        }

        async function syncToSheets() {
            if (!SHEETS_URL) {
                alert('‚ö†Ô∏è Primero configura la conexi√≥n con Google Sheets');
                openSheetsConfig();
                return;
            }

            const todaySales = sales.filter(s => isToday(s.timestamp));
            if (todaySales.length === 0) {
                alert('‚ÑπÔ∏è No hay ventas para guardar');
                return;
            }

            const btn = document.getElementById('btnSyncSheets');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Guardando...';

            try {
                console.log('üì§ Enviando', todaySales.length, 'ventas...');
                
                const response = await fetch(SHEETS_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({
                        action: 'save_sales',
                        sales: todaySales
                    })
                });

                console.log('üì• Respuesta:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const text = await response.text();
                console.log('üìÑ Respuesta texto:', text);
                
                const result = JSON.parse(text);
                console.log('‚úÖ Resultado:', result);
                
                if (result.status === 'success') {
                    const totalIngresos = todaySales.reduce((sum, s) => sum + s.amount, 0);
                    alert('‚úÖ ¬°DATOS GUARDADOS EXITOSAMENTE!\n\n' + 
                          `üìä Registros guardados: ${result.data.ventas}\n` +
                          `üé± Sesiones de mesas: ${result.data.mesas}\n` +
                          `üõí Productos vendidos: ${result.data.productos}\n` +
                          `üí∞ Total ingresos: ${totalIngresos.toLocaleString('es-CO')}\n\n` +
                          `Ve a tu Google Sheet para ver toda la informaci√≥n organizada.`);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('‚ùå ERROR AL GUARDAR\n\n' +
                      'Error: ' + error.message + '\n\n' +
                      'Posibles soluciones:\n' +
                      '‚Ä¢ Verifica que la URL sea correcta\n' +
                      '‚Ä¢ Crea una NUEVA implementaci√≥n\n' +
                      '‚Ä¢ Revisa los permisos del script\n' +
                      '‚Ä¢ Mira la consola (F12) para m√°s detalles');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // ========================================
        // MESAS
        // ========================================

        function initTables() {
            tables = [];
            for (let i = 1; i <= NUM_TABLES; i++) {
                tables.push({
                    id: i,
                    occupied: false,
                    startTime: null,
                    customers: [],
                    elapsedTime: 0
                });
            }
            renderTables();
            renderProductSelect();
        }

        function renderTables() {
            const grid = document.getElementById('tablesGrid');
            grid.innerHTML = tables.map(table => `
                <div class="table-item ${table.occupied ? 'occupied' : ''}" data-table-id="${table.id}">
                    <div class="table-number">Mesa ${table.id}</div>
                    <div class="table-status">${table.occupied ? 'Ocupada' : 'Disponible'}</div>
                    ${table.occupied ? `<div class="table-time" id="time-${table.id}">00:00:00</div>` : ''}
                </div>
            `).join('');
            
            // Agregar event listeners a cada mesa
            document.querySelectorAll('.table-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tableId = parseInt(this.getAttribute('data-table-id'));
                    openTableModal(tableId);
                });
            });
            
            updateStats();
        }

        function openTableModal(tableId) {
            const table = tables.find(t => t.id === tableId);
            const modal = document.getElementById('tableModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = `Mesa ${tableId}`;

            if (!table.occupied) {
                body.innerHTML = `
                    <p style="margin-bottom: 20px; color: #666;">
                        Mesa disponible. ¬øIniciar sesi√≥n?
                    </p>
                    <button class="btn btn-primary" id="btnStartTable">Iniciar Mesa</button>
                    <button class="btn btn-danger" id="btnCancelTable">Cancelar</button>
                `;
                
                document.getElementById('btnStartTable').addEventListener('click', () => startTable(tableId));
                document.getElementById('btnCancelTable').addEventListener('click', closeModal);
            } else {
                const elapsed = getElapsedTime(table.startTime);
                const tableCost = calculateCost(elapsed);
                
                let totalProducts = 0;
                table.customers.forEach(customer => {
                    customer.products.forEach(product => {
                        totalProducts += product.total;
                    });
                });
                
                const grandTotal = tableCost + totalProducts;
                
                body.innerHTML = `
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p><strong>‚è±Ô∏è Tiempo:</strong> ${formatTime(elapsed)}</p>
                        <p><strong>üíµ Costo Mesa:</strong> ${tableCost.toLocaleString('es-CO')}</p>
                        <p><strong>üõí Productos:</strong> ${totalProducts.toLocaleString('es-CO')}</p>
                        <p style="font-size: 1.3em; color: #667eea; font-weight: bold; margin-top: 10px;">
                            <strong>TOTAL:</strong> ${grandTotal.toLocaleString('es-CO')}
                        </p>
                    </div>

                    <div id="customersList">${renderCustomersList(table)}</div>

                    ${table.customers.length < 4 ? `
                        <button class="btn btn-primary" id="btnAddCustomer" style="width: 100%; margin-top: 15px;">
                            ‚ûï Agregar Cliente (${table.customers.length}/4)
                        </button>
                    ` : ''}

                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                        <button class="btn btn-success" id="btnEndTable" style="width: 100%; margin-bottom: 10px;">
                            ‚úì Finalizar y Cobrar
                        </button>
                        <button class="btn btn-danger" id="btnCloseTableModal">Cerrar</button>
                    </div>
                `;
                
                if (table.customers.length < 4) {
                    document.getElementById('btnAddCustomer').addEventListener('click', () => addCustomerToTable(tableId));
                }
                document.getElementById('btnEndTable').addEventListener('click', () => endTable(tableId));
                document.getElementById('btnCloseTableModal').addEventListener('click', closeModal);
            }

            modal.classList.add('active');
        }

        function renderCustomersList(table) {
            if (table.customers.length === 0) {
                return '<p style="text-align: center; color: #999; padding: 20px;">No hay clientes. Agrega el primero.</p>';
            }

            return table.customers.map((customer, idx) => {
                const customerTotal = customer.products.reduce((sum, p) => sum + p.total, 0);
                return `
                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="color: #667eea; margin: 0;">
                                üë§ ${customer.name || `Cliente ${idx + 1}`}
                            </h3>
                            <button class="btn btn-danger btn-remove-customer" data-table-id="${table.id}" data-customer-idx="${idx}" style="padding: 5px 10px; font-size: 0.85em;">‚úï</button>
                        </div>
                        
                        ${customer.products.length > 0 ? `
                            <div style="margin-bottom: 10px;">
                                ${customer.products.map((product, pIdx) => `
                                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8f9fa; border-radius: 6px; margin-bottom: 5px;">
                                        <span>${product.name} x${product.quantity}</span>
                                        <div>
                                            <strong style="color: #667eea;">${product.total.toLocaleString('es-CO')}</strong>
                                            <button class="btn-remove-product" data-table-id="${table.id}" data-customer-idx="${idx}" data-product-idx="${pIdx}" style="background: none; border: none; color: #f5576c; cursor: pointer; margin-left: 10px; font-weight: bold;">‚úï</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="color: #999; font-size: 0.9em;">Sin productos</p>'}
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                            <strong>Subtotal:</strong>
                            <strong style="color: #667eea; font-size: 1.2em;">${customerTotal.toLocaleString('es-CO')}</strong>
                        </div>
                        
                        <button class="btn btn-primary btn-add-product" data-table-id="${table.id}" data-customer-idx="${idx}" style="width: 100%; margin-top: 10px; padding: 8px;">
                            üõí Agregar Producto
                        </button>
                    </div>
                `;
            }).join('');
        }

        function attachCustomerListeners() {
            // Remover clientes
            document.querySelectorAll('.btn-remove-customer').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tableId = parseInt(this.getAttribute('data-table-id'));
                    const customerIdx = parseInt(this.getAttribute('data-customer-idx'));
                    removeCustomer(tableId, customerIdx);
                });
            });

            // Agregar productos
            document.querySelectorAll('.btn-add-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tableId = parseInt(this.getAttribute('data-table-id'));
                    const customerIdx = parseInt(this.getAttribute('data-customer-idx'));
                    addProductToCustomer(tableId, customerIdx);
                });
            });

            // Remover productos
            document.querySelectorAll('.btn-remove-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tableId = parseInt(this.getAttribute('data-table-id'));
                    const customerIdx = parseInt(this.getAttribute('data-customer-idx'));
                    const productIdx = parseInt(this.getAttribute('data-product-idx'));
                    removeProduct(tableId, customerIdx, productIdx);
                });
            });
        }

        function closeModal() {
            document.getElementById('tableModal').classList.remove('active');
        }

        function startTable(tableId) {
            const table = tables.find(t => t.id === tableId);
            table.occupied = true;
            table.startTime = Date.now();
            table.customers = [];
            
            activeIntervals[tableId] = setInterval(() => {
                updateTableTime(tableId);
            }, 1000);

            savePersistentData(); // GUARDAR ESTADO

            closeModal();
            renderTables();
            setTimeout(() => openTableModal(tableId), 300);
        }

        function addCustomerToTable(tableId) {
            const table = tables.find(t => t.id === tableId);
            
            if (table.customers.length >= 4) {
                alert('No puedes agregar m√°s de 4 clientes por mesa');
                return;
            }

            const modal = document.getElementById('tableModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = '‚ûï Agregar Cliente';
            body.innerHTML = `
                <div class="form-group">
                    <label>Nombre del Cliente (opcional)</label>
                    <input type="text" id="customerNameInput" placeholder="Ej: Pedro, Mar√≠a, Juan..." autofocus>
                </div>
                <p style="color: #999; font-size: 0.9em; margin-bottom: 20px;">
                    üí° Puedes dejar el nombre vac√≠o
                </p>
                <button class="btn btn-primary" id="btnConfirmAddCustomer">Agregar Cliente</button>
                <button class="btn btn-danger" id="btnCancelAddCustomer">Cancelar</button>
            `;

            document.getElementById('btnConfirmAddCustomer').addEventListener('click', () => confirmAddCustomer(tableId));
            document.getElementById('btnCancelAddCustomer').addEventListener('click', () => openTableModal(tableId));

            setTimeout(() => {
                const input = document.getElementById('customerNameInput');
                input.focus();
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') confirmAddCustomer(tableId);
                });
            }, 100);
        }

        function confirmAddCustomer(tableId) {
            const name = document.getElementById('customerNameInput').value.trim();
            const table = tables.find(t => t.id === tableId);
            table.customers.push({ name: name || '', products: [] });
            savePersistentData(); // GUARDAR ESTADO
            openTableModal(tableId);
            setTimeout(attachCustomerListeners, 100);
        }

        function removeCustomer(tableId, customerIdx) {
            if (!confirm('¬øEliminar este cliente y sus productos?')) return;
            const table = tables.find(t => t.id === tableId);
            table.customers.splice(customerIdx, 1);
            savePersistentData(); // GUARDAR ESTADO
            openTableModal(tableId);
            setTimeout(attachCustomerListeners, 100);
        }

        function addProductToCustomer(tableId, customerIdx) {
            const modal = document.getElementById('tableModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            const table = tables.find(t => t.id === tableId);
            const customer = table.customers[customerIdx];

            title.textContent = `Agregar Producto - ${customer.name || `Cliente ${customerIdx + 1}`}`;
            body.innerHTML = `
                <div class="form-group">
                    <label>Producto</label>
                    <select id="productSelectModal">
                        <option value="">Seleccionar producto</option>
                        ${products.map(p => 
                            `<option value="${p.name}|${p.price}">${p.name} - ${p.price.toLocaleString('es-CO')}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Cantidad</label>
                    <input type="number" id="productQuantityModal" value="1" min="1">
                </div>
                <button class="btn btn-primary" id="btnConfirmAddProduct">Agregar</button>
                <button class="btn btn-danger" id="btnCancelAddProduct">Volver</button>
            `;

            document.getElementById('btnConfirmAddProduct').addEventListener('click', () => confirmAddProduct(tableId, customerIdx));
            document.getElementById('btnCancelAddProduct').addEventListener('click', () => {
                openTableModal(tableId);
                setTimeout(attachCustomerListeners, 100);
            });
        }

        function confirmAddProduct(tableId, customerIdx) {
            const select = document.getElementById('productSelectModal');
            const quantity = parseInt(document.getElementById('productQuantityModal').value);
            
            if (!select.value || quantity < 1) {
                alert('Selecciona un producto y cantidad v√°lida');
                return;
            }

            const [productName, price] = select.value.split('|');
            const table = tables.find(t => t.id === tableId);
            const customer = table.customers[customerIdx];

            customer.products.push({
                name: productName,
                price: parseInt(price),
                quantity: quantity,
                total: parseInt(price) * quantity
            });

            savePersistentData(); // GUARDAR ESTADO

            openTableModal(tableId);
            setTimeout(attachCustomerListeners, 100);
        }

        function removeProduct(tableId, customerIdx, productIdx) {
            const table = tables.find(t => t.id === tableId);
            table.customers[customerIdx].products.splice(productIdx, 1);
            savePersistentData(); // GUARDAR ESTADO
            openTableModal(tableId);
            setTimeout(attachCustomerListeners, 100);
        }

        function updateTableTime(tableId) {
            const table = tables.find(t => t.id === tableId);
            if (table && table.occupied) {
                const elapsed = getElapsedTime(table.startTime);
                const element = document.getElementById(`time-${tableId}`);
                if (element) element.textContent = formatTime(elapsed);
            }
        }

        async function endTable(tableId) {
            const table = tables.find(t => t.id === tableId);
            const elapsed = getElapsedTime(table.startTime);
            const tableCost = calculateCost(elapsed);

            let productsTotal = 0;
            table.customers.forEach(customer => {
                customer.products.forEach(product => {
                    productsTotal += product.total;
                });
            });

            const grandTotal = tableCost + productsTotal;

            const saleData = {
                type: 'Mesa',
                item: `Mesa ${tableId}`,
                customers: table.customers.map((c, idx) => ({
                    name: c.name || `Cliente ${idx + 1}`,
                    products: c.products,
                    total: c.products.reduce((sum, p) => sum + p.total, 0)
                })),
                time: formatTime(elapsed),
                tableCost: tableCost,
                productsTotal: productsTotal,
                amount: grandTotal,
                timestamp: new Date()
            };

            sales.push(saleData);

            // GUARDAR AUTOM√ÅTICAMENTE EN GOOGLE SHEETS
            await saveToSheetsAuto([saleData]);

            clearInterval(activeIntervals[tableId]);
            delete activeIntervals[tableId];

            table.occupied = false;
            table.startTime = null;
            table.customers = [];
            table.elapsedTime = 0;

            savePersistentData(); // GUARDAR ESTADO

            closeModal();
            renderTables();
            renderSalesHistory();
        }

        // ========================================
        // VENTAS R√ÅPIDAS
        // ========================================

        function renderProductSelect() {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">Seleccionar producto</option>' +
                products.map(p => 
                    `<option value="${p.name}|${p.price}">${p.name} - ${p.price.toLocaleString('es-CO')}</option>`
                ).join('');
        }

        async function addQuickSale() {
            const select = document.getElementById('productSelect');
            const quantity = parseInt(document.getElementById('productQuantity').value);
            
            if (!select.value || quantity < 1) {
                alert('Por favor selecciona un producto y cantidad v√°lida');
                return;
            }

            const [product, price] = select.value.split('|');
            const total = parseInt(price) * quantity;

            const saleData = {
                type: 'Venta',
                item: `${product} x${quantity}`,
                amount: total,
                timestamp: new Date()
            };

            sales.push(saleData);

            // GUARDAR AUTOM√ÅTICAMENTE EN GOOGLE SHEETS
            await saveToSheetsAuto([saleData]);

            select.value = '';
            document.getElementById('productQuantity').value = '1';
            
            savePersistentData(); // GUARDAR ESTADO
            renderSalesHistory();
            updateStats();
            
            // Mensaje de confirmaci√≥n
            showNotification(`‚úì ${product} agregado y guardado`);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #43e97b; color: white; padding: 15px 25px; border-radius: 8px; font-weight: bold; z-index: 10000; animation: slideIn 0.3s ease;';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        // ========================================
        // HISTORIAL
        // ========================================

        function renderSalesHistory() {
            const history = document.getElementById('salesHistory');
            const todaySales = sales.filter(s => isToday(s.timestamp));
            
            if (todaySales.length === 0) {
                history.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay ventas registradas hoy</p>';
                return;
            }

            history.innerHTML = todaySales.slice().reverse().map(sale => {
                if (sale.type === 'Mesa') {
                    return `
                        <div class="history-item" style="flex-direction: column; align-items: flex-start;">
                            <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <strong style="font-size: 1.1em;">${sale.item}</strong>
                                    <br><small>${sale.timestamp.toLocaleTimeString('es-CO')} ‚Ä¢ Tiempo: ${sale.time}</small>
                                </div>
                                <div class="history-amount">${sale.amount.toLocaleString('es-CO')}</div>
                            </div>
                            
                            ${sale.customers && sale.customers.length > 0 ? `
                                <div style="width: 100%; background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 5px;">
                                    <strong style="font-size: 0.9em; color: #667eea;">Detalles:</strong>
                                    ${sale.customers.map(customer => `
                                        <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 6px;">
                                            <div style="font-weight: 600; color: #333;">üë§ ${customer.name}</div>
                                            ${customer.products.length > 0 ? `
                                                <div style="margin-top: 5px; font-size: 0.85em;">
                                                    ${customer.products.map(p => 
                                                        `<div style="color: #666;">‚Ä¢ ${p.name} x${p.quantity} - ${p.total.toLocaleString('es-CO')}</div>`
                                                    ).join('')}
                                                </div>
                                                <div style="margin-top: 5px; font-weight: 600; color: #667eea;">
                                                    Subtotal: ${customer.total.toLocaleString('es-CO')}
                                                </div>
                                            ` : '<div style="font-size: 0.85em; color: #999;">Sin productos</div>'}
                                        </div>
                                    `).join('')}
                                    <div style="margin-top: 10px; padding-top: 8px; border-top: 2px solid #e0e0e0; font-size: 0.9em;">
                                        <div>üíµ Mesa: ${sale.tableCost.toLocaleString('es-CO')}</div>
                                        <div>üõí Productos: ${sale.productsTotal.toLocaleString('es-CO')}</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    return `
                        <div class="history-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${sale.item}</strong>
                                <br><small>${sale.timestamp.toLocaleTimeString('es-CO')}</small>
                            </div>
                            <div class="history-amount">${sale.amount.toLocaleString('es-CO')}</div>
                        </div>
                    `;
                }
            }).join('');
        }

        function clearHistory() {
            if (confirm('¬øEst√°s seguro de limpiar todo el historial de hoy?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.')) {
                sales = [];
                savePersistentData();
                renderSalesHistory();
                updateStats();
                alert('‚úì Historial limpiado');
            }
        }

        function exportReport() {
            const todaySales = sales.filter(s => isToday(s.timestamp));
            
            if (todaySales.length === 0) {
                alert('‚ÑπÔ∏è No hay ventas para exportar');
                return;
            }
            
            const totalRevenue = todaySales.reduce((sum, s) => sum + s.amount, 0);
            
            let report = `REPORTE DE VENTAS - ${new Date().toLocaleDateString('es-CO')}\n`;
            report += `${'='.repeat(60)}\n\n`;
            report += `Total de Ventas: ${todaySales.length}\n`;
            report += `Ingresos Totales: ${totalRevenue.toLocaleString('es-CO')}\n\n`;
            report += `DETALLE DE VENTAS:\n`;
            report += `${'-'.repeat(60)}\n`;
            
            todaySales.forEach((sale, idx) => {
                report += `\n${idx + 1}. ${sale.item}\n`;
                report += `   Tipo: ${sale.type}\n`;
                if (sale.time) report += `   Tiempo: ${sale.time}\n`;
                report += `   Monto: ${sale.amount.toLocaleString('es-CO')}\n`;
                report += `   Hora: ${sale.timestamp.toLocaleTimeString('es-CO')}\n`;
                
                if (sale.customers && sale.customers.length > 0) {
                    report += `   Clientes:\n`;
                    sale.customers.forEach(customer => {
                        report += `     - ${customer.name}: ${customer.total.toLocaleString('es-CO')}\n`;
                        if (customer.products.length > 0) {
                            customer.products.forEach(p => {
                                report += `       ‚Ä¢ ${p.name} x${p.quantity}\n`;
                            });
                        }
                    });
                }
            });

            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_billar_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('‚úì Reporte exportado');
        }

        // ========================================
        // ESTAD√çSTICAS
        // ========================================

        function updateStats() {
            const activeTables = tables.filter(t => t.occupied).length;
            const todaySales = sales.filter(s => isToday(s.timestamp));
            const totalRevenue = todaySales.reduce((sum, s) => sum + s.amount, 0);

            document.getElementById('activeTables').textContent = activeTables;
            document.getElementById('totalRevenue').textContent = `${totalRevenue.toLocaleString('es-CO')}`;
            document.getElementById('totalSessions').textContent = todaySales.length;
        }

        // ========================================
        // CONFIGURACI√ìN - PRODUCTOS
        // ========================================

        function openSettingsModal() {
            const modal = document.getElementById('tableModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = 'Gestionar Productos';
            body.innerHTML = `
                <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                    <div id="productList"></div>
                </div>
                <div style="padding-top: 20px; border-top: 2px solid #f0f0f0;">
                    <h3 style="margin-bottom: 15px;">‚ûï Agregar Nuevo Producto</h3>
                    <div class="form-group">
                        <label>Nombre del Producto</label>
                        <input type="text" id="newProductName" placeholder="Ej: Pizza, Hamburguesa">
                    </div>
                    <div class="form-group">
                        <label>Precio ($)</label>
                        <input type="number" id="newProductPrice" placeholder="0" min="0" step="500">
                    </div>
                    <button class="btn btn-primary" id="btnAddNewProduct">Agregar</button>
                    <button class="btn btn-danger" id="btnCloseProductsModal">Cerrar</button>
                </div>
            `;
            
            renderProductList();
            modal.classList.add('active');
            
            document.getElementById('btnAddNewProduct').addEventListener('click', addProduct);
            document.getElementById('btnCloseProductsModal').addEventListener('click', closeModal);
        }

        function renderProductList() {
            const list = document.getElementById('productList');
            if (products.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay productos. Agrega el primero.</p>';
                return;
            }
            
            list.innerHTML = products.map((p, idx) => `
                <div class="product-item">
                    <div>
                        <strong>${p.name}</strong><br>
                        <span style="color: #667eea; font-weight: 600;">${p.price.toLocaleString('es-CO')}</span>
                    </div>
                    <button class="btn btn-danger btn-delete-product" data-product-idx="${idx}" style="padding: 8px 15px; font-size: 0.9em;">Eliminar</button>
                </div>
            `).join('');
            
            // Agregar event listeners
            document.querySelectorAll('.btn-delete-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-product-idx'));
                    deleteProduct(idx);
                });
            });
        }

        function addProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const price = parseInt(document.getElementById('newProductPrice').value);

            if (!name || !price || price < 0) {
                alert('Por favor ingresa un nombre y precio v√°lidos');
                return;
            }

            products.push({ name, price });
            saveConfig();
            renderProductList();
            renderProductSelect();
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductPrice').value = '';
            
            showNotification(`‚úì ${name} agregado`);
        }

        function deleteProduct(index) {
            const product = products[index];
            if (confirm(`¬øEliminar "${product.name}"?`)) {
                products.splice(index, 1);
                saveConfig();
                renderProductList();
                renderProductSelect();
                showNotification(`‚úì ${product.name} eliminado`);
            }
        }

        // ========================================
        // CONFIGURACI√ìN - MESAS
        // ========================================

        function openTablesConfig() {
            const modal = document.getElementById('tableModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = 'Configurar Mesas';
            body.innerHTML = `
                <div class="form-group">
                    <label>N√∫mero de Mesas</label>
                    <input type="number" id="numTablesInput" value="${NUM_TABLES}" min="1" max="20">
                </div>
                <p style="color: #999; font-size: 0.9em; margin-bottom: 20px;">
                    ‚ö†Ô∏è Al cambiar el n√∫mero de mesas, se reiniciar√° el sistema
                </p>
                <button class="btn btn-primary" id="btnUpdateTables">Guardar Cambios</button>
                <button class="btn btn-danger" id="btnCancelTables">Cancelar</button>
            `;
            modal.classList.add('active');
            
            document.getElementById('btnUpdateTables').addEventListener('click', updateNumTables);
            document.getElementById('btnCancelTables').addEventListener('click', closeModal);
        }

        function updateNumTables() {
            const newNum = parseInt(document.getElementById('numTablesInput').value);
            if (newNum < 1 || newNum > 20) {
                alert('El n√∫mero de mesas debe estar entre 1 y 20');
                return;
            }

            if (confirm('¬øEst√°s seguro? Esto reiniciar√° todas las mesas activas.')) {
                Object.keys(activeIntervals).forEach(key => {
                    clearInterval(activeIntervals[key]);
                });
                activeIntervals = {};
                NUM_TABLES = newNum;
                saveConfig();
                initTables();
                closeModal();
                showNotification(`‚úì Ahora tienes ${newNum} mesas`);
            }
        }

        // ========================================
        // CONFIGURACI√ìN - PRECIOS
        // ========================================

        function openPriceConfig() {
            const modal = document.getElementById('tableModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = 'Configurar Precios';
            body.innerHTML = `
                <div class="form-group">
                    <label>Precio por Hora de Mesa ($)</label>
                    <input type="number" id="hourlyRateInput" value="${HOURLY_RATE}" min="0" step="1000">
                </div>
                <p style="color: #999; font-size: 0.9em; margin-bottom: 20px;">
                    üí° Precio actual: ${HOURLY_RATE.toLocaleString('es-CO')}/hora
                </p>
                <button class="btn btn-primary" id="btnUpdatePrice">Guardar Cambios</button>
                <button class="btn btn-danger" id="btnCancelPrice">Cancelar</button>
            `;
            modal.classList.add('active');
            
            document.getElementById('btnUpdatePrice').addEventListener('click', updateHourlyRate);
            document.getElementById('btnCancelPrice').addEventListener('click', closeModal);
        }

        function updateHourlyRate() {
            const newRate = parseInt(document.getElementById('hourlyRateInput').value);
            if (newRate < 0) {
                alert('El precio debe ser positivo');
                return;
            }
            HOURLY_RATE = newRate;
            saveConfig();
            closeModal();
            showNotification(`‚úì Precio: ${HOURLY_RATE.toLocaleString('es-CO')}/hora`);
        }

        // ========================================
        // UTILIDADES
        // ========================================

        function getElapsedTime(startTime) {
            return Date.now() - startTime;
        }

        function formatTime(ms) {
            const seconds = Math.floor((ms / 1000) % 60);
            const minutes = Math.floor((ms / (1000 * 60)) % 60);
            const hours = Math.floor(ms / (1000 * 60 * 60));
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }

        function pad(num) {
            return num.toString().padStart(2, '0');
        }

        function calculateCost(ms) {
            const hours = ms / (1000 * 60 * 60);
            return Math.ceil(hours * HOURLY_RATE / 1000) * 1000;
        }

        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        // Cerrar modal al hacer click fuera
        document.getElementById('tableModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // ========================================
        // EVENT LISTENERS PRINCIPALES
        // ========================================

        document.getElementById('btnQuickSale').addEventListener('click', addQuickSale);
        document.getElementById('btnConfigSheets').addEventListener('click', openSheetsConfig);
        document.getElementById('btnManageProducts').addEventListener('click', openSettingsModal);
        document.getElementById('btnConfigTables').addEventListener('click', openTablesConfig);
        document.getElementById('btnConfigPrices').addEventListener('click', openPriceConfig);
        document.getElementById('btnSyncSheets').addEventListener('click', syncToSheets);
        document.getElementById('btnClearHistory').addEventListener('click', clearHistory);
        document.getElementById('btnExportReport').addEventListener('click', exportReport);

        // ========================================
        // INICIALIZACI√ìN
        // ========================================

        // Verificar login primero
        checkLogin();

        loadConfig();
        initTables();
        
        console.log('üé± Sistema de Billar cargado correctamente');
        console.log('üìä Mesas:', NUM_TABLES);
        console.log('üí∞ Precio/hora:', HOURLY_RATE);
        console.log('üõí Productos:', products.length);
        console.log('üë§ Usuario:', currentUser ? currentUser.username : 'No logueado');
    </script>
</body>
</html>
